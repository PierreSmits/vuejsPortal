// fichier à revoir et renvoyer en partie sur le site
[[_selenium_test]]
= Tests Selenium

== Ecrire des tests fonctionnels (seleniums-webdriver)

Il y a de multiple manières d`'écrire des tests de non régression, ce chapitre décrit comment écrire des tests pour les outils sélénium avec Webdriver de manière à pouvoir les exécuter via un serveur de non régression (de type jenkins) au travers de la solution grid de selenium.

Afin d'écrire, d`'exécuter en local, et de mettre au point un test, il est nécessaire d'installer l'addon org.ofbizextra.framework.test.webdriver-tools.
L'aide de cet addon contient l'ensemble des éléments à installer sur son poste.

Le navigateur par défaut avec selenium est firefox 28.0, pour lequel il existe des outils d'enregistrement de scénario.
Nous en conseillons deux, qui sont similaire : 

* selenium ide, outil le plus ancien et qui est le plus convivial dans un premier temps, il permet de mieux tester les expressions xpath (Téléchargement sur http://docs.seleniumhq.org/download/)
* selenium builder, outil adapté à la rédaction de test en java. (Téléchargement sur https://saucelabs.com/builder)

Avec ces deux outils, après l'enregistrement d'un test, il faut l'exporter en java pour le compléter.
Avec selenium ide exportez en ofbiz / webdriver et avec selenium builder exportez en java 

Il est possible d'utiliser les deux outils en même temps.

Cet aide n'est pas un tutoriel mais plutôt un pense bête des principales commandes utilisés.

La règle majeure à avoir à l'esprit lors de la réalisation d'un test, c'est qu'un script se déroule à vitesse machine, et il faut donc penser à gérer l'attente du résultat de toute action.
C'est à dire après un « click », il faut dire comment repérer que le traitement demandé est fini, avant d'enchaîner sur la suite.

Pour un test Selenium, il faut donc : 

* le serveur Selenium (après avoir récupéré le jar), et le lancer ainsi : java -jar /chemin_vers_le_jar/selenium-server-standalone-2.44.0.jar
* Aller dans le répertoire ofbiz, et initialiser les données (si pas déjà fait) : ./ant load-exttest
* Lancer ofbiz via ./ant start

Pensez aussi à configurer le fichier framework/testtools/selenium/resources/selenium.properties 
[source]
----
#WebDriver type : local, htmlUnit or grid
testType=grid
#targetBrowser type : firefox, chrome
targetBrowser=firefox

#Address to call from selenium grid node to contact ofbiz default to https://localhost:8443/
ofbizBaseUrl=https://localhost:8443/

#Address of the grid hub in most cases it will be http://localhost:4444/wd/hub/
gridHubUrl=http://localhost:4444/wd/hub/

#This address is used by ant to see if ofbiz is started or not
#only change the host name don't change protocol or port number or controller uri
ofbiz.started.test.url=http://localhost:8080/ordermgr/control/view

#the driver user for chrome browser ajsut depending or the server architecture 32 or 64 bit (both drivers under same directory)
#don't forget to start the node with with the following parameters if you are using the grid mode
#java -Dwebdriver.chrome.driver=<full-path>chromedriver-64 -jar selenium-server-standalone-2.42.2.jar -role node

webdriver.chrome.driver=resources/chromedriver-64

#two tag for helping lisibility of webdriver job output
# first one to show (or not) user message during the test. These message are done with showInfoPanel method
# second one to show message in log (first one should be to yes if this one is yes)
# be careful, with yes, the tests will be more longer because showInfoPanel included a wait for human being able to read the message
infoPanelEnabled=yes
logPanelMessage=yes
#define the scenario to be loaded and provide data for test cases
#data can be assigned for test-cases with scenario.
#scenario can be splitted in many files
dataScenario=test_tnr
record.video=yes
----

== Lancer un test Selenium

Le test Selenium se lance en ligne de commande en se plaçant dans le répertoire ofbiz

exemple : ./ant run-one-webdriver-test -DtestName=PartyMgmt

Cet exemple lance la classe PartyMgmt,java qui contient un test Selenium.

Ou pour une classe specifique

exemple : ./ant Selenium

Cet exemple lance les classes demandées via votre fichier SpecificTestRunner.java

== Contrôler le résultat

On peut voir le résultat du test, et ainsi voir les éventuelles erreurs via le fichier index dans votre ofbiz à l'emplacement framework/testtools/selenium/build/reports/html/index.htm


image::example_fr/image_selenium1.png[Visuel de contrôle]


== Création d'un Selenium via IDE

Il suffit de lancer firefox et aller dans Outils -> Selenium IDE (ou le raccourci Ctrl+Alt+s).

Ensuite, toutes les actions sont captées dans cet IDE.


image::example_fr/image_selenium2.png[Visuel de l'IDE]

Pour transformer le script en java, aller dans Fichier -> Exporter le Test sous -> Ofbiz/WebDriver

Sauver le script dans le répertoire ofbiz pour les tests selenium : framework/testtools/selenium/tests/org/ofbiz/testtools/webdriverTests/


image::example_fr/image_selenium3.png[Export en java via l'IDE]

Vous avez donc crée une classe Features, dans laquelle on pourra mettre tout ce qui concerne les caractéristiques (par exemple)

Vous obtenez un java avec le code transformé qui ressemblera ici à cela :

[source,java]
----
    driverWait = new WebDriverWait(driver, 30);
    driver.get(baseUrl + "/productAppro/control/main");
    sendKeys(By.xpath("//input[@name='USERNAME']"), "user");;
    sendKeys(By.xpath("//input[@name='PASSWORD']"), "ofbiz");;
    click(By.xpath("//input[@value='Login']"));
    click(By.xpath("//a[contains(@href, '/productAppro/control/showPortalPage?portalPageId=PA_PrdtFeatureMgmt&parentPortalPageId=PA_ProductMgmt')]"));
    click(By.xpath("//img[@title='Créer une catégorie de caractéristique']"));
    for (int second = 0;; second++) {
        if (second >= 60) fail("timeout");
        try { if (driver.findElement(By.id("EditProductFeatureCategory_qualifyingEnumId")).isDisplayed()) break; } catch (Exception e) {}
        Thread.sleep(1000);
    }

    selectByVisibleText(By.id("EditProductFeatureCategory_qualifyingEnumId"), "Obligatoire");
    selectByVisibleText(By.id("EditProductFeatureCategory_filterEnumId"), "Multiple");
    sendKeys(By.id("EditProductFeatureCategory_description"), "SELENIUM CARACTERISTIQUE");;
    click(By.xpath("//input[@name='createButton']"));
    click(By.xpath("//a[contains(@href, '/productAppro/control/logout')]"));
----

Pour la suite, je ne peux que vous suggérer de regarder les fichiers existants, contenants la façon de faire.

Cette nouvelle classe Features fait donc : 

* Se loguer
* Aller dans les caractéristiques articles
* Créer une caractéristique
* Récupérer l'id de la caractéristique
* Faire une recherche en utilisant l'id
* Aller en modification pour changer la description de la caractéristique
* logout

Cette classe manque de vérifications (assert), et autres contrôles, mais libre à vous d'en rajouter.

== Tips and Tricks

Pour pointer les champs sous java, il faut utiliser par ordre de préférence : id, name ou xpath.

Donc, souvent, l'IDE utilise des xpath, dans la mesure du possible, il faudrait utiliser id ou name.

.Méthode à utiliser
[cols="1,1", options="header"]
|===
| Objectif
| méthode

|Attendre l'apparition d'un id
|driverWait.until(ExpectedConditions.presenceOfElementLocated(By.id("xxxxx")));

|Attendre la disparition d'un id
|driverWait.until(ExpectedConditions.invisibilityOfElementLocated(By.id("xxxxxx")));

|Attendre la présence d'un texte (il peut contenir plus)
|driverWait.until(ExpectedConditions.textToBePresentInElement(By.cssSelector("li.nav-displaying"), "Displaying 21 - 25 of 25"));

|Attendre disparition d'un élément
|driverWait.until(ExpectedConditions.invisibilityOfElementLocated(By.xpath("(//div[@id='listLookupFacility_facilityId_div']/a")));

|Attente informelle de 2 secondes
|showInfoPanel("On va modifier les caractéristiques", 2);

|Attente visibilité
|driverWait.until(ExpectedConditions.visibilityOfElementLocated(By.id("EditFacility")));

|Attente Disparition d'un élément WebElement,
|WebElement we = driver.findElement(By.name("submitButton"));
source.click(By.name("submitButton"));
driverWait.until(ExpectedConditions.stalenessOf(we));

|Repérer par un id
|By.id("xxxxx")

|Repérer par un nom de champ
|By.name("exampleName")

|Repérer par le contenu d'un lien
|By.linkText("Search")

|Repérer par un nom d'une class
|By.className("nav-next")

|Repérer par xpath
|By.xpath("//div[@id='scrlt_ExampleItems']/div/ul/li/a"

|Repérer par xpath
|By.xpath("//div[@id='scrlt_ShowExample']/div[@class='screenlet-title-bar']"

|Repérer par xpath
|By.xpath("//form[@id='ShowExample']//td[normalize-space(.)='test description']"

|Repérer par xpath
|By.xpath("//form[@id='ShowExample']//td[.='test description']"

|Repérer par un élément de css
|By.cssSelector("input[type=\"submit\"]")

|Repérer par un élément de css
|By.cssSelector("img[title='Details']")

|Repérer par un élément de css
|By.cssSelector("#scrlt_ListExample > div.screenlet-title-bar > ul > li.collapsed > a[title='Expand']")

|Repérer en accrochant une portlet
|click(By.cssSelector("#EditProduct input[name=submitButton]"));
|===

* Pour trouver les id ou name, si il y en a, il est conseillé d'utiliser Chromium ; ainsi quand vous voulez connaître un élément, il faut le sélectionner avec le bouton droit de la souris, puis « Explorer l'élément » (Ctrl + Maj + I)
* N'hésitez pas à regarder dans les exemples existants, cela permet de trouver certaines syntaxes ou astuces.
* Les principaux soucis que vous pouvez avoir, seront des soucis avec la synchronisation du navigateur et ajax, qu'il sera facile de contourner. Par exemple dans un écran de modification, il peut y avoir un délai «ajax» entre le clic sur «Modifier» et l'affichage suivant à contrôler, aussi, il faut penser à attendre l'écran suivant avant de poursuivre.
+
Exemple 1
+

[source,java]
----
                click(By.id("ListFacilities_addFacility_a"));
                showInfoPanel("On va saisir l'emplacement " + facilityValue, 2);
                sendKeys(By.id("EditFacility_facilityId"), facilityValue);
                click(By.id("0_lookupId_button"));
                driverWait.until(ExpectedConditions.presenceOfElementLocated(By.id("ListFacilities_row0")));
                assertTrue(...
----
+
Ici on peux voir de l'information utilisateur avec un ShowInfoPanel, mais aussi un driverWait qui attend l'affichage suivant pour suivre les tests.
* Pour faire un bon Selenium, il est conseillé d'y aller progressivement et de ne pas hésiter à utiliser les commentaires.
+

[source,java]
----
        // ceci est une ligne de commentaires
----
+

[source,java]
----
            /* Ceci est
                un aussi un 
                commentaire sur plusieurs lignes */
----
* Un exemple de test classique : faire la création, ensuite faire la modification, en commentant la partie création, et ainsi de suite ; et quand tout est fini, vous n'avez qu'à dé-commenter.
+
L'avantage de cette méthode est d'éviter de relancer tous les tests quand vous êtes entrain de développer.
* L'utilisation de méthodes, permet d'éviter de reproduire du code déjà fait, et ainsi d'optimiser la compréhension.
* Quand on prend un xpath de chromium, il met des doubles quotes (« ) , donc attention à les remplacer par des simple quotes ('), sachant qu'on peut aussi intégrer des « \ » pour que certaines ne soient pas interprétées.
+

[source,java]
----
        assertTrue("Test1",driver.findElements(By.cssSelector("img[title=\"Test1\"]")).size()>0);
----
* Sous Eclipse, il ne faut pas hésiter à utiliser l'intellisense, car documentation en anglais de toutes les fonctions, c'est pratique quand on ne connaît pas d'avance ce qu'on veut utiliser et que l'on doit chercher.
* Affichage d'une portlet, puis test sur le titre (ou son début); si le titre est un lien (vers l'aide)
+

[source,java]
----
driver.findElement(By.cssSelector("img[title=\"Items\"]")).click();
driverWait.until(ExpectedConditions.textToBePresentInElement(By.xpath("//div[@id='scrlt_ExampleItems']/div/ul/li/a"), "List Example Items EX14 :"));
----
* Affichage d'une portlet, puis test sur le titre (ou son début); si le titre n'est pas un lien
+

[source,java]
----
driver.findElement(By.cssSelector("img[title=\"Items\"]")).click();
driverWait.until(ExpectedConditions.textToBePresentInElement(By.xpath("//div[@id='scrlt_ExampleItems']/div/ul/li"), "List Example Items EX14 :"));
----
* Affichage d'un formulaire, puis test sur la présence d'un bouton
+

[source,java]
----
driver.findElement(By.cssSelector("img[title=\"Add\"]")).click();
driverWait.until(ExpectedConditions.presenceOfElementLocated(By.name("submitButton")));
----
* Validation d'un formulaire, puis test sur la disparition d'un bouton
+

[source,java]
----
driver.findElement(By.linkText("Back")).click();
driverWait.until(ExpectedConditions.invisibilityOfElementLocated(By.linkText("Back")));
----
* Tester la présence de texte 
+
[source,java]
----
assertEquals("test selenium", driver.findElement(By.xpath("//tr[@id='ExampleItems_row_0']/td[2]")).getText());
----
ou 
[source,java]
----
assertTrue(driver.findElement(By.xpath("//tr[@id='ExampleItems_row_0']/td[2]")).getText().contains("test selenium"));
----
* Tester que la liste contient 5 lignes (la première ligne c'est 0)
+

[source,java]
----
assertTrue(driver.findElements(By.id("ListExamples_row_4")).size()!=0);
assertTrue(driver.findElements(By.id("ListExamples_row_5")).size()==0);
----
* Tester que le bouton est affiché
+

[source,java]
----
assertTrue(driver.findElement(By.xpath("//div[@id='ExampleItems_deleteLink_0_div']//img[@title='Delete']")).isDisplayed());
----
* Tester que l'affichage d'une boite de dialogue puis valider
+

[source,java]
----
driverWait.until(ExpectedConditions.alertIsPresent());
Alert alert = driver.switchTo().alert();
assertTrue(alert.getText().matches("^Vous confirmez [\\s\\S]$"));
alert.accept();
----
* Test présence d'un élément
+

[source,java]
----
            if(isElementPresent(By.id("ListFacilities_facilityId_0_div"), driver)) {...
----
* Attendre la visibilité
+

[source,java]
----
            driverWait.until(ExpectedConditions.visibilityOfElementLocated(By.id("EditFacility_facilityId")));
----
* Attendre la localisation
+

[source,java]
----
            driverWait.until(ExpectedConditions.presenceOfElementLocated(By.id(fieldName)));
----
* Tester bouton
+

[source,java]
----
    WebElement we = driver.findElement(By.name("submitButton"));
    source.click(By.name("submitButton"));
    driverWait.until(ExpectedConditions.stalenessOf(we));
----
* Attendre l'invisible
+

[source,java]
----
            driverWait.until(ExpectedConditions.invisibilityOfElementLocated(By.xpath("(//div[@id='Lookup_refId_div']/a")));
----
* Attendre la non présence
+

[source,java]
----
            driverWait.until(ExpectedConditions.stalenessOf(element);
----
* Test présence d'un texte
+

[source,java]
----
            assertTrue(driver.findElement(By.id("CategoryId_title")).getText().contains("Catégorie [Réf.]"));
----
* Attendre un texte bien précis
+

[source,java]
----
            driverWait.until(ExpectedConditions.textToBePresentInElementLocated(By.xpath("//*[@id='Category']/table/tbody/tr[1]/td[2]"), refCategorieId));
----


== Tests normaux

* En pratique, voici le déroulement pour tester via 3 terminaux:
+

[source]
----
Tester via 3 terminaux

# lancement du selenium server standalone (Terminal 1)
        java -jar selenium-server-standalone-2.44.0.jar
# Régler Selenium
        framework/testtools/selenium/resources/selenium.properties
# Régler les classes à exécuter
     framework/testtools/selenium/tests/org/ofbiz/testtools/projetSelenium/ProjetTestRunner.java
# Installer la base
        Exemple : psql -U ofbiz -h localhost -f ofbiz-prod.sql monofbiz2
# Lancer load pour test
        ./ant load-exttest
# Lancer Ofbiz (Terminal 2)
        ./ant start
# Lancer le test Selenium (Terminal 3)
        ./ant Selenium
# Les terminaux 1 & 2 ne bougeront plus, seul le Terminal 3 servira à relancer les tests.
----


=== Tests Vidéos

* En pratique, voici le déroulement pour tester en ayant la vidéo
+

[source]
----
Pour tester et obtenir une vidéo (4 terminaux)

1) charger le jar
http://sourceforge.net/projects/ofbizextra/?source=typ_redirect
2) Dans le fichier properties, rajouter la vidéo
                record.video=yes

3) Lancer le hub (Terminal 1)
        java -jar grid-service-provider-20150704.jar -role hub
4) Dans le nœud (Terminal 2)
        java -jar grid-service-provider-20150704.jar -role node -hub http://localhost:4444/grid/register

5) Lancer le serveur ofbiz (Terminal 3)
        ./ant start
6) Lancer le test Selenium (Terminal 4)
        ./ant Selenium

La vidéo se trouvera alors dans /framework/testtools/selenium/build/reports/outputs
----


== Gestion des données scénarisées

* Gestion des données scénarisées
+

[source]
----
# Définir le scénario à utiliser via framework/testtools/selenium/resources/selenium.properties ; ajouter le scénario à utiliser
#define the scenario to be loaded and provide data for test cases
#data can be assigned for test-cases with scenario.
#scenario can be splitted in many files
dataScenario=test_tnr

# Ajouter un fichier scénario (peux importe le nom), avec ce scénario
par exemple : /framework/testtools/selenium/resources/tests-data/Projet-TNR.xml

# Dans le fichier scénario, mettre les données
<?xml version="1.0" encoding="UTF-8"?>
<testdata xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://ofbiz.apache.org/dtds/testcasedata.xsd">
    <version>1.0</version>
    <scenario name="test_tnr">
        <test-case name="TestProjet">
            <data-obj name="objet">
                <string name="maChaine" value="la valeur"/>
            </data-obj>
        </test-case>
    </scenario>
</testdata>

pour récupérer la donnée :
     String user = scenario.getTestCase("TestProjet").getDataObj("objet").getString("maChaine");

On sait que c'est test_tnr, grâce à ce qui a été précédemment déclaré dans le fichier selenium_properties.
----
* Exemple pratique : 
+

[source]
----

<?xml version="1.0" encoding="UTF-8"?>
<testdata xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://ofbiz.apache.org/dtds/testcasedata.xsd">
    <version>1.0</version>
    <scenario name="test_tnr">
        <test-case name="maClasse">
            <data-obj name="login">
                <string name="username" value="ser"/>
                <string name="password" value="ofbiz"/>
            </data-obj>
        </test-case>
        <test-case name="Features">
            <data-obj name="liste">
                <string name="desc" value="liste des chats"/>
            </data-obj>
        </test-case>
    </scenario>
</testdata>

# Dans vos classes de test, vous pouvez ainsi récupérer la donnée :

     String user = scenario.getTestCase("maClasse").getDataObj("login").getString("username");
     String password = scenario.getTestCase("maClasse").getDataObj("login").getString("password");

On récupère ici donc les valeurs qui sont présentent dans le scénario test_tnr, pour la classe maClasse, et la méthode/regroupement login,

    String description = scenario.getTestCase("Features").getDataObj("liste").getString("desc");
----

